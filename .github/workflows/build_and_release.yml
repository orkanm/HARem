name: Build and Release Firmware

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Compile ESPHome Firmware
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Create Dummy Secrets
        run: |
          echo "wifi_ssid: 'TEST_SSID'" > secrets.yaml
          echo "wifi_password: 'TEST_PASSWORD'" >> secrets.yaml
          echo "2_wifi_ssid: 'TEST_SSID_2'" >> secrets.yaml
          echo "2_wifi_password: 'TEST_PASSWORD_2'" >> secrets.yaml
          echo "3_wifi_ssid: 'TEST_SSID_3'" >> secrets.yaml
          echo "3_wifi_password: 'TEST_PASSWORD_3'" >> secrets.yaml
          echo "api_key: 'BASE64_TEST_KEY_MUST_BE_VALID_LENGTH_='" >> secrets.yaml
          echo "ota_password: 'TEST_OTA_PASSWORD'" >> secrets.yaml
          # Note: The API key below is a random valid base64 key for compilation only
          sed -i 's/key: "7knRB3\/EL4Fq8Foul7Yhv+pcABzyLXHSQxa9bTzzQqg="/key: "7knRB3\/EL4Fq8Foul7Yhv+pcABzyLXHSQxa9bTzzQqg="/' remote_controller.yaml || true

      - name: Build Firmware
        id: esphome-build
        uses: esphome/build-action@v1.8.0
        with:
          yaml_file: remote_controller.yaml
          version: latest

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: firmware-v${{ github.run_number }}
          path: ${{ steps.esphome-build.outputs.name }}

  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        
      # Download artifact from previous job requires re-downloading or persisting. 
      # Simpler to just re-build or assume the build job does the release. 
      # To keep this simple single-file:
      
      - name: Download Firmware Artifact
        uses: actions/download-artifact@v3
        with:
          name: firmware-v${{ github.run_number }}
          path: output/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: output/*.bin
          generate_release_notes: true
